---
title: "Scrape Lab"
author: "Ziwei Liu"
date: "2018/12/8"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r, message=FALSE}
library(rvest)
library(stringr)
library(tidyr)
html = "ultra.html"
my_webpage = read_html(html)

ultra <- my_webpage %>%
  html_node("table") %>%
  html_table()

ultra = separate(ultra, "Date", c("Weekday","Date", "Year"),sep = ", ")
ultra = separate(ultra, "Date", c("Month", "Day"),sep = " ")
ultra$`Sale Price` = as.integer(str_extract(ultra$`Sale Price`, "([0-9]{2,4})"))

head(ultra)
```

```{r, warning=FALSE, message=FALSE, eval=TRUE}
library(RSelenium); library(XML); library(rvest)
rD = rsDriver()
remDr = rD$client

search = function(web, shoe, remDr) {
  remDr$navigate(web)
  wenElem = remDr$findElement(using = "id", "home-search")
  wenElem$sendKeysToElement(list(shoe))
  Sys.sleep(5)
}

direct = function(remDr) {
  target = remDr$findElement(using = "class", "list-item-content")
  target$clickElement() 
  Sys.sleep(5)
}

get_table = function(remDr) {
  table = remDr$findElement(using = "class", "latest-sales-container")
  doc = htmlParse(table$getPageSource()[[1]])
  readHTMLTable(doc)
}

get_picture = function(remDr) {
  pic = remDr$findElement(using = "class", "product-media")
  html = pic$getPageSource()[[1]]
  container = read_html(html)
  selector = "div:nth-child(1) > img"
  img_url = container %>%
    html_node(selector) %>%
    html_attr("src")
  download.file(img_url, "shoe.png", mode = "wb")
  return("shoe.png")
}

# begin search
search("https://stockx.com", "aj11", remDr)
direct(remDr)

# get price
get_table(remDr)

# get picture
get_picture(remDr)

get_info = function(remDr) {
  table = get_table(remDr)
  image = get_picture(remDr)
  return(list(table = table, 
              image = image))
}
list = get_info(remDr)

# stop
rD$server$stop()
```

```{r handle table, warning=FALSE, message=FALSE, eval=TRUE}

```




